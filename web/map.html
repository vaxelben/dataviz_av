<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carte des vidéos - DuckDB</title>
  <style>
    :root {
      --bg: #0f172a; --panel: #0b1220; --text: #e5e7eb; --muted: #9ca3af; --border: #1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial}
    header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    header a{color:var(--muted);text-decoration:none}
    main{padding:16px;max-width:1200px;margin:0 auto}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:1000px){.row{grid-template-columns:300px 1fr}}
    label{display:block;margin-bottom:8px;color:var(--muted);font-size:13px}
    select,input{width:100%;padding:8px 10px;background:#0f172a;border:1px solid var(--border);border-radius:8px;color:var(--text)}
    .legend{display:flex;gap:8px;align-items:center;margin-top:8px}
    .legend span{font-size:12px;color:var(--muted)}
    svg{width:100%;height:auto;background:transparent}
    .tooltip{position:fixed;pointer-events:none;background:#111827;border:1px solid var(--border);padding:8px 10px;border-radius:8px;font-size:12px;color:var(--text);display:none}
  </style>
</head>
<body>
  <header>
    <div>Carte des vidéos par pays (distinct video_id)</div>
    <a href="/">Retour</a>
  </header>
  <main>
    <div class="row">
      <div class="panel">
        <!-- Source unique: yt_clean -->
        <label style="margin-top:10px">Date (video_trending_date)</label>
        <input id="dateSlider" type="range" min="0" max="0" step="1" value="0" style="width:100%" />
        <div class="muted" id="dateLabel" style="margin-top:6px">—</div>
        <div class="legend">
          <span>0</span>
          <svg width="140" height="12" viewBox="0 0 140 12">
            <defs>
              <linearGradient id="g" x1="0" x2="1">
                <stop offset="0%" stop-color="#0ea5e9"></stop>
                <stop offset="100%" stop-color="#22c55e"></stop>
              </linearGradient>
            </defs>
            <rect x="0" y="0" width="140" height="12" fill="url(#g)" rx="6"></rect>
          </svg>
          <span id="maxv">max</span>
        </div>
      </div>
      <div class="panel">
        <div id="map-wrap"></div>
      </div>
    </div>
  </main>
  <div class="tooltip" id="tip"></div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script>
    const $ = sel => document.querySelector(sel);
    const tip = $('#tip');
    
    // Fonction pour convertir une date YYYY-MM-DD en format français dd/MM/yyyy
    function formatDateFrench(dateStr) {
      if (!dateStr) return dateStr;
      const parts = dateStr.split('-');
      if (parts.length === 3) {
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return dateStr;
    }
    const wrap = $('#map-wrap');
    const maxv = $('#maxv');
    let dates = [];
    const dateSlider = document.getElementById('dateSlider');
    const dateLabel = document.getElementById('dateLabel');

    const width = 980, height = 540;
    const svg = d3.select('#map-wrap').append('svg').attr('viewBox', `0 0 ${width} ${height}`);
    const g = svg.append('g');
    const projection = d3.geoNaturalEarth1().scale(165).translate([width/2, height/2]);
    const path = d3.geoPath(projection);
    const color = d3.scaleSequential(d3.interpolateTurbo).domain([0, 1]);

    // Normalisation des noms (minuscule, sans accents, synonymes usuels)
    function normalizeName(s){
      if(!s) return null;
      let k = String(s).trim().toLowerCase();
      k = k.normalize('NFD').replace(/[\u0300-\u036f]/g, ''); // enlève accents
      const synonyms = {
        'united states': 'united states of america',
        'usa': 'united states of america',
        'uk': 'united kingdom',
        'great britain': 'united kingdom',
        'russia': 'russian federation',
        'south korea': 'korea, republic of',
        'north korea': "korea, democratic people's republic of",
        'czech republic': 'czechia',
        'ivory coast': "cote d'ivoire",
        'congo-kinshasa': 'democratic republic of the congo',
        'congo-brazzaville': 'republic of the congo',
        'swaziland': 'eswatini',
        'cape verde': 'cabo verde',
        'laos': 'lao pdr',
        'myanmar': 'myanmar',
        'burma': 'myanmar'
      };
      return synonyms[k] || k;
    }

    async function fetchAgg(){
      const qs = new URLSearchParams();
      if(dates.length){
        const idx = +dateSlider.value || 0;
        const onDate = dates[Math.max(0, Math.min(idx, dates.length-1))];
        if(onDate) qs.set('onDate', onDate);
      }
      const res = await fetch(`/api/agg/country?${qs.toString()}`);
      const js = await res.json();
      if(!res.ok) throw new Error(js.error||'Erreur API');
      return js;
    }

    async function loadWorld(){
      const topo = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json').then(r=>r.json());
      const geo = topojson.feature(topo, topo.objects.countries);
      return geo;
    }

    function render(geo, data){
      // data: {data:[{country: 'France'|code|nom local, count:n}], max:n}
      const counts = new Map();
      for(const d of data.data){
        const key = normalizeName(d.country);
        if(key) counts.set(key, d.count||0);
      }
      const max = Math.max(1, data.max||0);
      color.domain([0, max]);
      maxv.textContent = String(max);

      g.selectAll('path').data(geo.features).join('path')
        .attr('d', path)
        .attr('fill', d => {
          const key = normalizeName(d.properties && d.properties.name);
          const v = counts.get(key) || 0;
          return v ? color(v) : '#0b1220';
        })
        .attr('stroke', '#1f2937').attr('stroke-width', 0.6)
        .on('mousemove', (ev, d) => {
          const key = normalizeName(d.properties && d.properties.name);
          const v = counts.get(key) || 0;
          tip.style.display = 'block';
          tip.style.left = (ev.clientX + 12) + 'px';
          tip.style.top = (ev.clientY + 12) + 'px';
          tip.textContent = `${d.properties.name}: ${v}`;
        })
        .on('mouseleave', ()=>{ tip.style.display = 'none'; });
    }

    async function init(){
      const [geo, dateList] = await Promise.all([
        loadWorld(),
        fetch(`/api/meta/dates`).then(r=>r.json()).catch(()=>({dates:[]}))
      ]);
      dates = (dateList && Array.isArray(dateList.dates)) ? dateList.dates : [];
      dateSlider.min = 0; dateSlider.max = Math.max(0, dates.length-1); dateSlider.value = Math.max(0, dates.length-1);
      dateLabel.textContent = dates.length ? formatDateFrench(dates[+dateSlider.value]) : '—';
      const agg = await fetchAgg();
      render(geo, agg);
      // listeners
      // Source fixe: yt_clean (pas d'écouteur de changement de table)
      dateSlider.addEventListener('input', async ()=>{
        dateLabel.textContent = dates.length ? formatDateFrench(dates[+dateSlider.value]) : '—';
        const a = await fetchAgg(); render(geo, a);
      });
    }

    init();
  </script>
</body>
</html>


